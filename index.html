<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alpacas Music Battle</title>
    <style></style>
  </head>
  <body>
    <h1>Alpacas Music Battle</h1>

    <h2>modo:</h2>

    <div id="video_title"></div>
    <button id="fullGame">Masoquista</button>
    <button id="mediumGame">Normal</button>
    <button id="quickGame">Precoce</button>
    <br /><br />
    <button id="addMusic">adicionar Musicas</button>

    <script>
      const fullList = [
        "https://www.youtube.com/watch?v=h3oDa3mRVKY",
        "https://www.youtube.com/watch?v=zZJcXSh0rqI",
        "https://www.youtube.com/watch?v=QfvBN1KX_UM",
        "https://www.youtube.com/watch?v=hxOY0Kn4Snk",
        "https://www.youtube.com/watch?v=nCWtflan6fY",
        "https://youtu.be/dsCklARUcXk",
        "https://youtu.be/D1FcYknxEY0",
      ];
      const chave = "AIzaSyAcM3fuIbRmXAPVUAsbi7wpywukclOu2a0";

      //HTML
      const fullGame = document.querySelector("#fullGame");
      const mediumGame = document.querySelector("#mediumGame");
      const quickGame = document.querySelector("#quickGame");

      const gamePage = `
        <div class="container">
          <iframe id="video1" loading="eager" src="" allowfullscreen></iframe>
           <div class="videoTitle" id='videoTitle1'></div>
          <button id="vote1">Vote Video 1</button><br />
          <iframe id="video2" loading="eager" src="" allowfullscreen></iframe>
          <div class="videoTitle" id='videoTitle2'></div>
          <button id="vote2">Vote Video 2</button><br />
        </div>
      `;

      const winnerPage = `
            <div>
              <div class="videoTitle" id='videoTitleWinner'></div>
              <iframe id='winner' src="" allowfullscreen></iframe>
              <button id="reset" onclick="location.reload()">Reset</button>
            </div>
          `;

      const notEnoughVideosPage = `
        <div class="container">
          <h1>Sem musicas suficientes</h1>
          <button id="addMusic">adicionar Musicas</button>
          <button id="reset" onclick="location.reload()">Reset</button>
        </div>
      `;

      //utility funcs
      function sliceList(list, fraction) {
        return list
          .sort(() => Math.random() - 0.5)
          .slice(0, Math.ceil(list.length * fraction));
      }

      function getRandomIndex(excludeIndex = -1, list) {
        let randomIndex;
        do {
          randomIndex = Math.floor(Math.random() * list.length);
        } while (randomIndex === excludeIndex);
        return randomIndex;
      }

      async function getVideoTitle(videoId) {
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${chave}&part=snippet`
        );
        const data = await response.json();

        return data.items[0].snippet.title;
      }

      function getVideoId(url) {
        const regex =
          /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/|.+\?v=)|youtu\.be\/)([^&\s]+)/;
        const videoId = url.match(regex)[1];
        return videoId;
      }

      function displayTitle(id, htmlElement) {
        getVideoTitle(id).then((title) => {
          if (title) {
            htmlElement.innerHTML = `${title}`;
          }
        });
      }

      //game modes
      fullGame.addEventListener("click", () =>
        startGame(sliceList(videoIdsList, 1))
      );
      mediumGame.addEventListener("click", () =>
        startGame(sliceList(videoIdsList, 0.5))
      );
      quickGame.addEventListener("click", () =>
        startGame(sliceList(videoIdsList, 0.25))
      );

      //starting game
      const videoIdsList = fullList.map(getVideoId);

      function startGame(playingList) {
        const enoughVideos = playingList.length >= 2;
        if (enoughVideos) {
          //HTML
          document.body.innerHTML = gamePage;

          const video1 = document.querySelector("#video1");
          const video2 = document.querySelector("#video2");
          const videoTitle1 = document.querySelector("#videoTitle1");
          const videoTitle2 = document.querySelector("#videoTitle2");
          const vote1 = document.querySelector("#vote1");
          const vote2 = document.querySelector("#vote2");

          function setVideos() {
            const winner = playingList.length === 1;
            if (winner) {
              document.body.innerHTML = winnerPage;
              const winner = document.querySelector("#winner");
              const winnerTitle = document.querySelector("#videoTitleWinner");

              winner.src = `https://www.youtube.com/embed/${playingList[0]}`;

              displayTitle(playingList[0], winnerTitle);
              return;
            }

            const firstIndex = getRandomIndex(-1, playingList);
            const secondIndex = getRandomIndex(firstIndex, playingList);

            video1.src = `https://www.youtube.com/embed/${playingList[firstIndex]}`;
            video2.src = `https://www.youtube.com/embed/${playingList[secondIndex]}`;

            displayTitle(playingList[firstIndex], videoTitle1);
            displayTitle(playingList[secondIndex], videoTitle2);
          }

          //vote
          function vote(videoToRemove) {
            playingList = playingList.filter(
              (video) => video !== getVideoId(videoToRemove.src)
            );
            setVideos();
          }

          vote1.addEventListener("click", () => vote(video2));
          vote2.addEventListener("click", () => vote(video1));

          //start
          setVideos();
        } else {
          document.body.innerHTML = notEnoughVideosPage;
        }
      }
    </script>
  </body>
</html>
