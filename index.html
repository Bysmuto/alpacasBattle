<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alpacas Music Battle</title>
    <style></style>
  </head>
  <body>
    <h1>Alpacas Music Battle</h1>

    <h2>modo:</h2>
    <div id="video_title"></div>
    <button id="fullGame">Masoquista</button>
    <button id="mediumGame">Normal</button>
    <button id="quickGame">Precoce</button>
    <br /><br />
    <button id="addMusic">adicionar Musicas</button>

    <script>
      const fullList = [
        "https://www.youtube.com/watch?v=h3oDa3mRVKY",
        "https://www.youtube.com/watch?v=zZJcXSh0rqI",
        "https://www.youtube.com/watch?v=QfvBN1KX_UM",
        "https://www.youtube.com/watch?v=hxOY0Kn4Snk",
        "https://www.youtube.com/watch?v=nCWtflan6fY",
      ];


      const videoIds = fullList.map(getVideoId);



      const fullGame = document.querySelector("#fullGame");
      const mediumGame = document.querySelector("#mediumGame");
      const quickGame = document.querySelector("#quickGame");

      const chave = "AIzaSyAcM3fuIbRmXAPVUAsbi7wpywukclOu2a0";

      function getVideoId(url) {
        const regex =
          /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/|.+\?v=)|youtu\.be\/)([^&\s]+)/;
        const videoId = url.match(regex)[1];
        return videoId;
      }
 

      async function getVideoTitle(videoId) {
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${chave}&part=snippet`
        );
        const data = await response.json();

        return data.items[0].snippet.title;
      }

      const gamePage = `
        <div class="container">
          <iframe id="video1" src="" allowfullscreen></iframe>
          <button id="vote1">Vote Video 1</button><br />
          <iframe id="video2" src="" allowfullscreen></iframe>
          <button id="vote2">Vote Video 2</button><br />
        </div>
      `;

      const winnerPage = `
            <div>
              <h1>Winner!</h1>
              <iframe id='winner' src="" allowfullscreen></iframe>
              <button id="reset" onclick="location.reload()">Reset</button>
            </div>
          `;

      const emptyListPage = `
        <div class="container">
          <h1>Sem musicas</h1>
          <button id="addMusic">adicionar Musicas</button>
          <button id="reset" onclick="location.reload()">Reset</button>
        </div>
      `;

      fullGame.addEventListener("click", () =>
        startGame(sliceList(videoIds, 1))
      );
      mediumGame.addEventListener("click", () =>
        startGame(sliceList(videoIds, 0.5))
      );
      quickGame.addEventListener("click", () =>
        startGame(sliceList(videoIds, 0.25))
      );

      function sliceList(list, fraction) {
        return list
          .sort(() => Math.random() - 0.5)
          .slice(0, Math.ceil(list.length * fraction));
      }

      function startGame(playingList) {
        if (playingList.length >= 2) {



          console.log(playingList);


          

          document.body.innerHTML = gamePage;

          const video1 = document.querySelector("#video1");
          const video2 = document.querySelector("#video2");
          const vote1 = document.querySelector("#vote1");
          const vote2 = document.querySelector("#vote2");

          function getRandomIndex(excludeIndex = -1) {
            let randomIndex;
            do {
              randomIndex = Math.floor(Math.random() * playingList.length);
            } while (randomIndex === excludeIndex);
            return randomIndex;
          }

          function setVideos() {
            console.log(playingList);
            if (playingList.length === 1) {
              displayWinner();
              return;
            }

            const firstIndex = getRandomIndex();
            const secondIndex = getRandomIndex(firstIndex);

            video1.src = `https://www.youtube.com/embed/${playingList[firstIndex]}`;
            video2.src = `https://www.youtube.com/embed/${playingList[secondIndex]}`;
          }

          function displayWinner() {
            document.body.innerHTML = winnerPage;
            const winner = document.querySelector("#winner");
            winner.src = `https://www.youtube.com/embed/${playingList[0]}`; 
          }

          function vote(videoToRemove) {
            playingList = playingList.filter(
              (video) => video !== getVideoId(videoToRemove.src) 
            );
            setVideos();
          }

          vote1.addEventListener("click", () => vote(video2));
          vote2.addEventListener("click", () => vote(video1));

          setVideos();
        } else {
          document.body.innerHTML = emptyListPage;
        }
      }
    </script>
  </body>
</html>
