<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alpacas Music Battle</title>
    <style></style>
  </head>
  <body>
    <h1>Alpacas Music Battle</h1>

    <h2>modo:</h2>

    <div id="video_title"></div>
    <button id="fullGame">Masoquista</button>
    <button id="mediumGame">Normal</button>
    <button id="quickGame">Precoce</button>
    <br /><br />
    <button id="addMusic">adicionar Musicas</button>

    <script type="module">
      // external config
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBTL8WPwcuTKlkWOCVQBSuZWfAVwZ-gJk8",
        authDomain: "alpacasbattle.firebaseapp.com",
        projectId: "alpacasbattle",
        storageBucket: "alpacasbattle.firebasestorage.app",
        messagingSenderId: "857337327051",
        appId: "1:857337327051:web:30affc0c4cdf2eccf55a4e",
      };

      const ytk = "AIzaSyAcM3fuIbRmXAPVUAsbi7wpywukclOu2a0";

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // HTML elements
      const fullGame = document.querySelector("#fullGame");
      const mediumGame = document.querySelector("#mediumGame");
      const quickGame = document.querySelector("#quickGame");

      const gamePage = `
        <div class="container">
          <iframe id="video1" loading="lazy" src="" allowfullscreen></iframe>
          <div class="videoTitle" id='videoTitle1'></div>
          <button id="vote1">Vote Video 1</button><br />
          <iframe id="video2" loading="lazy" src="" allowfullscreen></iframe>
          <div class="videoTitle" id='videoTitle2'></div>
          <button id="vote2">Vote Video 2</button><br />
        </div>
      `;

      const winnerPage = `
        <div>
          <div class="videoTitle" id='videoTitleWinner'></div>
          <iframe id='winner' src="" allowfullscreen></iframe>
          <button id="reset" onclick="location.reload()">Reset</button>
        </div>
      `;

      const notEnoughVideosPage = `
        <div class="container">
          <h1>Sem músicas suficientes</h1>
          <button id="addMusic">Adicionar músicas</button>
          <button id="reset" onclick="location.reload()">Reset</button>
        </div>
      `;

      // utility functions
      function sliceList(list, fraction) {
        return list
          .sort(() => Math.random() - 0.5)
          .slice(0, Math.ceil(list.length * fraction));
      }

      function getRandomIndex(excludeIndex = -1, list) {
        let randomIndex;
        do {
          randomIndex = Math.floor(Math.random() * list.length);
        } while (randomIndex === excludeIndex);
        return randomIndex;
      }

      async function getVideoTitle(videoId) {
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${ytk}&part=snippet`
        );
        const data = await response.json();
        return data.items[0].snippet.title;
      }

      function getVideoId(url) {
        const regex =
          /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:.*[?&]v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const videoId = url.match(regex)[1];
        return videoId;
      }

      function displayTitle(id, htmlElement) {
        getVideoTitle(id).then((title) => {
          if (title) {
            htmlElement.innerHTML = `${title}`;
          }
        });
      }

      // Fetch data from Firebase
      get(ref(database, "videos")).then((snapshot) => {
        if (snapshot.exists()) {
          const videos = snapshot.val();

          const videosIdsList = videos.map(getVideoId);

          // Game modes
          fullGame.addEventListener("click", () =>
            startGame(sliceList(videosIdsList, 1))
          );
          mediumGame.addEventListener("click", () =>
            startGame(sliceList(videosIdsList, 0.3))
          );
          quickGame.addEventListener("click", () =>
            startGame(sliceList(videosIdsList, 0.15))
          );

          //  game logic
          function startGame(playingList) {
            const enoughVideos = playingList.length >= 2;
            if (enoughVideos) {
              // HTML
              document.body.innerHTML = gamePage;

              const video1 = document.querySelector("#video1");
              const video2 = document.querySelector("#video2");
              const videoTitle1 = document.querySelector("#videoTitle1");
              const videoTitle2 = document.querySelector("#videoTitle2");
              const vote1 = document.querySelector("#vote1");
              const vote2 = document.querySelector("#vote2");

              function setVideos() {
                console.log(playingList);
                if (playingList.length === 1) {
                  document.body.innerHTML = winnerPage;
                  const winner = document.querySelector("#winner");
                  const winnerTitle =
                    document.querySelector("#videoTitleWinner");

                  winner.src = `https://www.youtube.com/embed/${playingList[0]}`;
                  displayTitle(playingList[0], winnerTitle);
                  return;
                }

                const firstIndex = getRandomIndex(-1, playingList);
                const secondIndex = getRandomIndex(firstIndex, playingList);

                video1.src = `https://www.youtube.com/embed/${playingList[firstIndex]}?autoplay=0&controls=0&rel=0&showinfo=0`;
                video2.src = `https://www.youtube.com/embed/${playingList[secondIndex]}?autoplay=0&controls=0&rel=0&showinfo=0`;

                displayTitle(playingList[firstIndex], videoTitle1);
                displayTitle(playingList[secondIndex], videoTitle2);
              }

              // vote
              function vote(videoToRemove) {
                setTimeout(() => {
                  playingList = playingList.filter(
                    (video) => video !== getVideoId(videoToRemove.src)
                  );
                  setVideos();
                }, 200);
              }

              vote1.addEventListener("click", () => vote(video2));
              vote2.addEventListener("click", () => vote(video1));

              // start
              setVideos();
            } else {
              document.body.innerHTML = notEnoughVideosPage;
            }
          }
        }
      });
    </script>
  </body>
</html>
